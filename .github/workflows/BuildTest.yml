name: Build and Test on Windows

on:
  push:
    branches:
      - master
    paths-ignore:  # 忽略logs目录的变更，防止循环触发
      - 'logs/**'
  pull_request:
    branches:
      - master

jobs:
  Build_And_Test_Logs_To_File:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Visual Studio latest
        uses: microsoft/setup-msbuild@v1.1
        with:
          vs-version: 'latest'

      - name: Compile Demo Programs
        run: |
          cd examples
          g++.exe demo1.cpp -o demo1.exe -lole32
          g++.exe demo2.cpp -o demo2.exe -lole32
          g++.exe demo3.cpp -o demo3.exe -lole32
          g++.exe demo4.cpp -o demo4.exe -lole32
          g++.exe demo5.cpp -o demo5.exe -lole32

      - name: Check if demo.exe exists
        run: |
          $logPath = "logs/BuildTest.log"
          New-Item -ItemType Directory -Force -Path logs | Out-Null
          if (Test-Path "examples\\demo1.exe") {
            "Compilation successful, demo1.exe found. Run." | Out-File -FilePath $logPath -Append
          } else {
            "Compilation failed, demo1.exe not found." | Out-File -FilePath $logPath -Append
            exit 1
          }
          
          if (Test-Path "examples\\demo2.exe") {
            "Compilation successful, demo2.exe found. Run." | Out-File -FilePath $logPath -Append
          } else {
            "Compilation failed, demo2.exe not found." | Out-File -FilePath $logPath -Append
            exit 1
          }
        
          if (Test-Path "examples\\demo3.exe") {
            "Compilation successful, demo3.exe found. Run." | Out-File -FilePath $logPath -Append
          } else {
            "Compilation failed, demo3.exe not found." | Out-File -FilePath $logPath -Append
            exit 1
          }

          if (Test-Path "examples\\demo4.exe") {
            "Compilation successful, demo4.exe found. Run." | Out-File -FilePath $logPath -Append
          } else {
            "Compilation failed, demo4.exe not found." | Out-File -FilePath $logPath -Append
            exit 1
          }

          if (Test-Path "examples\\demo5.exe") {
            "Compilation Successful, demo5.exe found. Run." | Out-File -FilePath $logPath -Append
          } else {
            "demo5.exe not found." | Out-File -FilePath $logPath -Append
          }

      - name: Run Demo
        run: |
          cd examples
          .\demo1.exe
          .\demo2.exe
          .\demo3.exe
          .\demo4.exe
          .\demo5.exe

      - name: Upload build logs
        uses: actions/upload-artifact@v3
        with:
          name: build-logs
          path: logs/

  Update_Logs:
    runs-on: windows-latest
    needs: Build_And_Test_Logs_To_File
    permissions:
      contents: write  # 必须要有写权限才能推送
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取全部提交历史

      - name: Download build logs
        uses: actions/download-artifact@v3
        with:
          name: build-logs
          path: logs/

      - name: Commit and push logs
        run: |
          git config user.name "github-actions"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add logs/
          if (git status --porcelain) {
            git commit -m "Auto-update build logs [skip ci]"
            git push
          } else {
            Write-Output "No changes to commit"
          }
